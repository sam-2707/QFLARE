<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50" x-data="adminDashboard">
    <!-- Navigation -->
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">QFLARE Admin - System Management</h1>
            <div class="space-x-4">
                <a href="/" class="hover:text-blue-200">Dashboard</a>
                <a href="/devices" class="hover:text-blue-200">Devices</a>
                <a href="/enrollment" class="hover:text-blue-200">Enrollment</a>
                <a href="/admin" class="text-yellow-300">Admin</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        <!-- Header -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800">System Administration</h2>
            <p class="text-gray-600">Monitor system health and manage platform operations</p>
        </div>

        <!-- System Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-700">System Status</h3>
                        <p class="text-2xl font-bold" :class="systemStatus === 'healthy' ? 'text-green-600' : 'text-red-600'" x-text="systemStatus"></p>
                    </div>
                    <div class="w-3 h-3 rounded-full" :class="systemStatus === 'healthy' ? 'bg-green-500' : 'bg-red-500'"></div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-700">Uptime</h3>
                <p class="text-2xl font-bold text-blue-600" x-text="systemUptime">00:00:00</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-700">Memory Usage</h3>
                <p class="text-2xl font-bold text-purple-600" x-text="memoryUsage">0%</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-700">Active Connections</h3>
                <p class="text-2xl font-bold text-orange-600" x-text="activeConnections">0</p>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- System Controls -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold">System Controls</h3>
                </div>
                <div class="p-6 space-y-4">
                    <button @click="startTraining" 
                            class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 focus:ring-2 focus:ring-green-500"
                            :disabled="isTraining">
                        <span x-show="!isTraining">Start Federation Training</span>
                        <span x-show="isTraining">Training In Progress...</span>
                    </button>
                    <button @click="stopTraining" 
                            class="w-full bg-red-600 text-white py-3 px-4 rounded-md hover:bg-red-700 focus:ring-2 focus:ring-red-500"
                            :disabled="!isTraining">
                        Stop Training
                    </button>
                    <button @click="backupSystem" 
                            class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
                        Create System Backup
                    </button>
                    <button @click="clearLogs" 
                            class="w-full bg-yellow-600 text-white py-3 px-4 rounded-md hover:bg-yellow-700 focus:ring-2 focus:ring-yellow-500">
                        Clear System Logs
                    </button>
                </div>
            </div>

            <!-- Configuration -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold">Configuration</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Model Update Frequency</label>
                        <select x-model="config.updateFrequency" @change="updateConfig" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="1">Every Round</option>
                            <option value="5">Every 5 Rounds</option>
                            <option value="10">Every 10 Rounds</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Min Devices Required</label>
                        <input type="number" x-model="config.minDevices" @change="updateConfig" min="1" max="100"
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Security Level</label>
                        <select x-model="config.securityLevel" @change="updateConfig"
                                class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="standard">Standard</option>
                            <option value="high">High</option>
                            <option value="maximum">Maximum</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Approval Queue -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="p-6 border-b">
                <h3 class="text-lg font-semibold">Pending Device Approvals</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Device ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Organization</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Registered</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <template x-for="device in pendingDevices" :key="device.device_id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="device.device_id"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="device.organization"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="device.device_type"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(device.registered_at)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="space-x-2">
                                        <button @click="approveDevice(device.device_id)" class="text-green-600 hover:text-green-900">Approve</button>
                                        <button @click="rejectDevice(device.device_id)" class="text-red-600 hover:text-red-900">Reject</button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="pendingDevices.length === 0">
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">No pending approvals</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- System Logs -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b">
                <h3 class="text-lg font-semibold">Recent System Logs</h3>
            </div>
            <div class="p-6">
                <div class="bg-gray-900 text-green-400 p-4 rounded-md font-mono text-sm max-h-64 overflow-y-auto">
                    <template x-for="log in systemLogs" :key="log.id">
                        <div class="mb-1">
                            <span class="text-gray-400" x-text="formatTime(log.timestamp)"></span>
                            <span :class="{
                                'text-red-400': log.level === 'ERROR',
                                'text-yellow-400': log.level === 'WARN',
                                'text-blue-400': log.level === 'INFO',
                                'text-green-400': log.level === 'DEBUG'
                            }" x-text="'[' + log.level + ']'"></span>
                            <span x-text="log.message"></span>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('adminDashboard', () => ({
                systemStatus: 'healthy',
                systemUptime: '00:00:00',
                memoryUsage: '45%',
                activeConnections: 12,
                isTraining: false,
                pendingDevices: [],
                systemLogs: [],
                config: {
                    updateFrequency: '5',
                    minDevices: 3,
                    securityLevel: 'high'
                },

                async init() {
                    await this.loadPendingDevices();
                    await this.loadSystemLogs();
                    await this.loadSystemStatus();
                    this.startStatusUpdates();
                },

                async loadPendingDevices() {
                    try {
                        const response = await fetch('/api/v2/devices?status=pending');
                        if (response.ok) {
                            this.pendingDevices = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to load pending devices:', error);
                    }
                },

                async loadSystemLogs() {
                    // Mock system logs for demo
                    this.systemLogs = [
                        { id: 1, timestamp: new Date(), level: 'INFO', message: 'System startup completed successfully' },
                        { id: 2, timestamp: new Date(Date.now() - 60000), level: 'INFO', message: 'Device edge-node-001 connected' },
                        { id: 3, timestamp: new Date(Date.now() - 120000), level: 'WARN', message: 'High memory usage detected' },
                        { id: 4, timestamp: new Date(Date.now() - 180000), level: 'INFO', message: 'Training round 15 completed' },
                        { id: 5, timestamp: new Date(Date.now() - 240000), level: 'ERROR', message: 'Device timeout: edge-node-003' }
                    ];
                },

                async loadSystemStatus() {
                    try {
                        const response = await fetch('/api/v2/system/status');
                        if (response.ok) {
                            const status = await response.json();
                            this.systemStatus = status.status || 'healthy';
                            this.isTraining = status.training_active || false;
                        }
                    } catch (error) {
                        console.error('Failed to load system status:', error);
                    }
                },

                startStatusUpdates() {
                    setInterval(() => {
                        // Update uptime
                        const now = new Date();
                        const start = new Date(now.getTime() - (Math.random() * 86400000)); // Random uptime
                        const diff = now - start;
                        const hours = Math.floor(diff / 3600000);
                        const minutes = Math.floor((diff % 3600000) / 60000);
                        const seconds = Math.floor((diff % 60000) / 1000);
                        this.systemUptime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        
                        // Simulate changing metrics
                        this.memoryUsage = (40 + Math.random() * 20).toFixed(0) + '%';
                        this.activeConnections = Math.floor(8 + Math.random() * 10);
                    }, 1000);
                },

                async startTraining() {
                    this.isTraining = true;
                    try {
                        const response = await fetch('/api/v2/training/start', { method: 'POST' });
                        if (!response.ok) {
                            this.isTraining = false;
                            alert('Failed to start training');
                        }
                    } catch (error) {
                        this.isTraining = false;
                        console.error('Failed to start training:', error);
                    }
                },

                async stopTraining() {
                    try {
                        const response = await fetch('/api/v2/training/stop', { method: 'POST' });
                        if (response.ok) {
                            this.isTraining = false;
                        } else {
                            alert('Failed to stop training');
                        }
                    } catch (error) {
                        console.error('Failed to stop training:', error);
                    }
                },

                async approveDevice(deviceId) {
                    try {
                        const response = await fetch(`/api/v2/devices/${deviceId}/approve`, { method: 'PUT' });
                        if (response.ok) {
                            await this.loadPendingDevices();
                        } else {
                            alert('Failed to approve device');
                        }
                    } catch (error) {
                        console.error('Failed to approve device:', error);
                    }
                },

                async rejectDevice(deviceId) {
                    try {
                        const response = await fetch(`/api/v2/devices/${deviceId}/reject`, { method: 'PUT' });
                        if (response.ok) {
                            await this.loadPendingDevices();
                        } else {
                            alert('Failed to reject device');
                        }
                    } catch (error) {
                        console.error('Failed to reject device:', error);
                    }
                },

                backupSystem() {
                    alert('System backup initiated. This may take a few minutes.');
                },

                clearLogs() {
                    if (confirm('Are you sure you want to clear all system logs?')) {
                        this.systemLogs = [];
                        alert('System logs cleared');
                    }
                },

                updateConfig() {
                    // Here you would typically send the config to the server
                    console.log('Config updated:', this.config);
                },

                formatDate(dateString) {
                    if (!dateString) return 'N/A';
                    return new Date(dateString).toLocaleString();
                },

                formatTime(timestamp) {
                    return timestamp.toLocaleTimeString();
                }
            }));
        });
    </script>
</body>
</html>